# Development notes - Directory Services Operator

## Installing the Operator from source


The operator is deployed from source with the following command:

```bash
make manifests
kustomize build  config/default | kubectl apply -f -
```

## Secrets

Key material is now generated by cert-manager. Consult [README.md](README.md) for more information.

Additional secrets (passwords) for testings can be generated by the operator, or 
pre-created with other tooling. 

You must provide at a minimum the following secret

* ds - keystore with the master keystore and pin.

## Development Workflow

Note:

While the directory needs to run in Kubernetes, it is much easier to develop the operator running locally (outside of the cluster):

```bash
# See below for dev mode explanation
# Note: the makefile run target sets these env vars for you.
export DEV_MODE=true
export DEBUG_CONTAINERS=true
make install
make run
# In another window...
kubectl apply -f hack/ds-kustomize/cert.yaml
kubectl apply -f hack/ds-kustomize/ds.yaml
kubectl scale directoryservice/ds --replicas=2
kubectl delete -f hack/ds-kustomize/ds.yaml
```

### Development and Debug modes

* export DEV_MODE=true: The ldap connection to the pod uses localhost
* export DEBUG_CONTAINER=true: Debug containers will be injected into the DS pods


When testing out of cluster, the controller on your desktop needs to open ldap connections to the directory that is
running in Kubernetes.
Setting DEV_MODE=true makes the operator connect to localhost:1636 to manage the DS instance, instead of the Kubernetes
pod hostname (default.ds-idrepo-0.ds-idrepo.cluster.local, for example) In dev mode, port forward to the ds container:

```bash
kubectl port-forward ds-idrepo-0 1636
```

The port-forwarding trick allows the operator running on your desktop to communicate with the directory server. This is needed
for any LDAP functionality such as setting application passwords.

DEBUG_CONTAINERS injects debug containers into the DS pods. Minikube uses the hostpath csi provisioner to test
volume snapshots. The hostpath provisioner does not `chmod`  volumes to the `forgerock` user, resulting
in permission error when trying to write to the data volume. In dev mode, a debug init container
performs a `chown -R forgerock:0` to the data volume to correct this. This workaround is only needed when using
the hostpath CSI provisioner.

## Current Feature Set

* StatefulSet is created
* Headless service created
* Deleting the CR properly cleans up the statefulset and service (owner refs are working OK). PVC is left behind - which is a good thing
* Scale subresource support (`kubectl scale directoryservice/ds --replicas=2`)
* Service account passwords are now supported. The operator can change the account passwords for AM, IDM, etc..
* backup / restore  (preview)
* Volume snapshots support.

Updating the spec.podTemplate.image will update the statefulset and perform a rolling update. For example:

```bash
kubectl patch directoryservice/ds --type='json' \
   -p='[{"op": "replace", "path": "/spec/podTemplate/image", "value":"us-docker.pkg.dev/forgeops-public/images/ds:2021-12-01"}]'
```

## Future Directions / TODOs 

* More status updates and events, especially for backup / restore CRDS
* 
* Patching strategy on DS image updates
* STS updates? See https://kubernetes.io/docs/tutorials/stateful-application/basic-stateful-set/#updating-statefulsets
In 1.17, some sts settings can be updated: image, Resource req/limit, labels and annotations. Might be useful to adjust JVM memory and allow restart
* Proxy and external TCP L4 access.
* Alerts?
 * Disk full alerts?
* Tuning. How do we tune backend params, or is that a function of the docker image?


## Release Process

To create a new release, create a tag. You can do this in GitHub or from the git cli. 

There are two independent processes that are triggered:

- A Cloud Run docker trigger builds the ds-operator docker image and pushes it to `us-docker.pkg.dev/forgeops-public/images/ds-operator:$TAG`
- A GitHub Action triggers and renders the kustomize manifests in `config/default`. The manifest is
added to the release files on GitHub. The image name will be replaced in the manifest with the
proper tag. 

## Implementation Notes

(Scratch Notes to implementers...)

cn=monitor - status we might want to use for the operator status:

ds-mon-disk-root=/opt/opendj/db,cn=disk space monitor,cn=monitor
ds-mon-disk-free   - disk free space on /opt/opendj/db (data partition). Specific to the node queried, but should be relatively equal


cn=jvm,cn=monitor
ds-mon-jvm-memory-heap-used
ds-mon-jvm-memory-heap-max

ds-mon-domain-name=dc=openidm\,dc=forgerock\,dc=io,cn=replicas,cn=replication,cn=monitor
ds-mon-status
objectclass: ds-monitor-replica (structural)

ds-mon-server-id=ds-0,cn=servers,cn=topology,cn=monitor
objectclass: ds-monitor-topology-server (structural)
ds-mon-replication-domain - multi value- each entry is a dn that is replicated. ou=identities, etc.


